
@{
    ViewBag.Title = "Create";
}

@using WebMatrix.Data
@{
    var db = Database.Open("BoardGame");
    var insertGame = "insert into BoardGame(BGGId, Name, YearPublished, Description, GameWeight, MinPlayers, MaxPlayers, BestPlayers, LanguageEase, numOwned, Family, ImagePath) values (@0,@1,@2,@3,@4,@5,@6,@7,@8,@9,@10,@11)";
    var Name = Request.Form["gameName"];
    var Year = Request.Form["year"];
    var Description = Request.Form["description"];
    var Weight = Request.Form["weight"];
    var Image_URL = Request.Form["image_URL"];
    var Category = Request.Form["category"];
    var Family = Request.Form["family"];
    var Theme = Request.Form["theme"];
    var Language_ease = Request.Form["ease"];
    var Number_owned = Request.Form["owned"];
    var Min_player = Request.Form["min_play"];
    var Max_player = Request.Form["max_play"];
    var Best_player = Request.Form["best_play"];

    var category_query = "Select C.CategoryID, C.Category from Category as C";
    var allCategory = db.Query(category_query).ToList();

    var family_query = "Select * from GameFamily";
    var allFamily = db.Query(family_query).ToList();

    var theme_query = "Select * from Theme";
    var allTheme = db.Query(theme_query).ToList();

    if (IsPost)
    {
        var new_theme = Request.Form["new_theme"];

        // Normalize blank or unselected options
        Category = string.IsNullOrWhiteSpace(Category) ? null : Category;
        Family = string.IsNullOrWhiteSpace(Family) ? null : Family;
        Theme = string.IsNullOrWhiteSpace(Theme) ? null : Theme;
        new_theme = string.IsNullOrWhiteSpace(new_theme) ? null : new_theme;

        // Handle "new" theme case
        if (Theme == "new" && new_theme != null)
        {
            try
            {
                Theme = "T" + (allTheme.Count() + 1);
                db.Execute("INSERT INTO Theme(ThemeID, ThemeName) VALUES (@0, @1)", Theme, new_theme);
            }
            catch
            {
                <div class="alert alert-danger text-center" role="alert">
                    Cannot insert new theme. Please try again.
                </div>;
            }
        }

        // Get next BGGId
        var BGGIdRecord = db.QuerySingle("SELECT MAX(BGGId) AS maxBGGId FROM BoardGame");
        var BGGId = BGGIdRecord.maxBGGId + 1;

        // Insert game record
        db.Execute(insertGame, BGGId, Name, Year, Description, Weight, Min_player, Max_player,
            Best_player, Language_ease, Number_owned, Family, Image_URL);

        // Insert relationships only if values exist
        if (Category != null)
        {
            db.Execute("INSERT INTO GameCategory(BGGId, Category) VALUES(@0,@1)", BGGId, Category);
        }

        if (Theme != null && Theme != "new")
        {
            db.Execute("INSERT INTO GameInThemes(BGGId, ThemeID) VALUES(@0,@1)", BGGId, Theme);
        }
        else if (Theme == "new")
        {
            db.Execute("INSERT INTO GameInThemes(BGGId, ThemeID) VALUES(@0,@1)", BGGId, "T" + (allTheme.Count() + 1));
        }

        <div class="alert alert-success text-center" role="alert">
            Insert success
        </div>;

        Response.Redirect("Edit?id=" + BGGId);
    }
}

<h2 class="text-center bg-secondary m-2">Create Product</h2>
<form action="/Home/Create" method="post" class="containerc p-4 border rounded shadow-sm bg-info">
    <div class="row">
        <b>BGGId # [Auto]</b>

        <b class="mb-0 px-0">Name <span class="text-danger">*</span></b>
        <input type="text" name="gameName" class="ms-1 mb-2 form-control" placeholder="Board game name..." required>

        <b class="mb-0 px-0">Year Published <span class="text-danger">*</span></b>
        <input type="date" name="year" class="ms-1 mb-2 form-control" placeholder="Board game Publish year..." required>

        <b class="mb-0 px-0">Category </b>
        <select name="category" class="ms-1 mb-2 form-control">
            <option value="Null" selected disabled>Select Category...</option>
            @foreach (var category in allCategory)
            {
                <option value="@category.categoryID">@(category.Category)</option>
            }
        </select>

        <b class="mb-0 px-0">Family</b>
        <select name="family" class="ms-1 mb-2 form-control">
            <option value="" selected>Select Family...</option>
            @foreach (var family in allFamily)
            {
                <option value="@family.FamilyCode">@(family.Family)</option>
            }
        </select>

        <b class="mb-0 px-0">Theme</b>
        <select id="theme" name="theme" class="ms-1 mb-2 form-control">
            <option value="Null" selected disabled>Select Theme...</option>
            @foreach (var theme in allTheme)
            {
                <option value="@theme.ThemeID">@theme.ThemeName</option>
            }
            <option value="new">A new theme</option>
        </select>
        <span id="new_theme" hidden><input type="text" id="new_theme_input" name="new_theme" class="ms-1 mb-2 form-control" required value="" placeholder="Enter the new theme name here" /></span>

        @section Scripts {
            <script>
                document.getElementById("theme").addEventListener("change", function () {
                    const newThemeSection = document.getElementById("new_theme");
                    const newThemeInput = document.getElementById("new_theme_input");

                    if (this.value == "new") {
                        newThemeSection.hidden = false;
                        newThemeInput.required = true; // enable required when visible
                    } else {
                        newThemeSection.hidden = true;
                        newThemeInput.required = false; // disable required when hidden
                        newThemeInput.value = ""; // clear any leftover value
                    }
                });
            </script>
        }

        <b class="mb-0 px-0">Game weight <span class="text-danger">*</span></b>
        <input type="number" step="0.01" name="weight" class="ms-1 mb-2 form-control" min="0.00" required>

        <b class="mb-0 px-0">Minimum players <span class="text-danger">*</span></b>
        <input type="number" step="1" name="min_play" class="ms-1 mb-2 form-control" min="1" required>

        <b class="mb-0 px-0">Maximum players <span class="text-danger">*</span></b>
        <input type="number" step="1" name="max_play" class="ms-1 mb-2 form-control" min="1" required>

        <b class="mb-0 px-0">Best number of players </b>
        <input type="number" step="1" name="best_play" class="ms-1 mb-2 form-control" min="1">

        <b class="mb-0 px-0">Language ease</b>
        <input type="number" step="1" name="ease" class="ms-1 mb-2 form-control">

        <b class="mb-0 px-0">Number of player owned the game</b>
        <input type="number" step="1" name="owned" class="ms-1 mb-2 form-control">

        <b class="mb-0 px-0">Description</b>
        <textarea name="description" placeholder="Game Description" class="ms-1 mb-2 form-control" style="height:200px"></textarea>

        <b class="mb-0 px-0">Image URL</b>
        <input type="text" name="image_URL" placeholder="Image URL" class="form-control" />

    </div>
    <div class="d-flex justify-content-end">
        <button type="submit" class="btn btn-success my-2 me-1">Create</button>
        <button type="reset" class="btn btn-danger my-2">Clear</button>
    </div>
</form>
